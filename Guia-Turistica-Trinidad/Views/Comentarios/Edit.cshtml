@model guia_turistico.Models.Comentarios

@{
    ViewData["Title"] = "Editar Comentario";
    var texto = Model.Texto ?? "";
    var puntuacion = Model.Puntuacion;
    var fecha = Model.Fecha.ToString("yyyy-MM-dd");
}

<div class="container py-4">
    <!-- Header con navegación -->
    <div class="bg-primary-gradient text-white py-4">
        <div class="container">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
                <div class="text-center text-md-start">
                    <h1 class="display-6 fw-bold mb-1">
                        <i class="fas fa-edit me-2"></i>Editar Comentario
                    </h1>
                    <p class="lead mb-0 opacity-75">Modifica la reseña o comentario sobre el sitio turístico</p>
                </div>
                <a asp-action="Index" class="btn btn-outline-light btn-lg">
                    <i class="fas fa-arrow-left me-2"></i>Volver al Listado
                </a>
            </div>
        </div>
    </div>

    <!-- Formulario Principal -->
    <div class="container py-4">
        <form asp-action="Edit" id="commentForm" class="needs-validation" novalidate>
            @Html.AntiForgeryToken()
            <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
            <input type="hidden" asp-for="ComentarioId" />
            <input type="hidden" asp-for="SitioTuristicoId" />
            <input type="hidden" asp-for="UsuarioId" />

            <!-- Sección de Información Actual -->
            <div class="card shadow-lg mb-5 border-0 overflow-hidden">
                <div class="card-header bg-primary bg-gradient py-3 text-white">
                    <h3 class="h5 mb-0">
                        <i class="fas fa-info-circle me-2"></i>Información del Comentario
                    </h3>
                </div>
                <div class="card-body p-0">
                    <div class="row g-0">
                        <!-- Información del Sitio y Usuario -->
                        <div class="col-lg-8">
                            <div class="p-4">
                                <h5 class="fw-semibold mb-3">
                                    <i class="fas fa-comment me-2 text-primary"></i>Datos del Comentario
                                </h5>

                                <div class="alert alert-info alert-dismissible fade show mb-3" role="alert">
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    <small>
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Instrucciones:</strong> Revisa y modifica los datos del comentario.
                                    </small>
                                </div>

                                <!-- Sitio Turístico (solo lectura) -->
                                <div class="form-group mb-4">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-landmark me-2 text-muted"></i>Sitio Turístico
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-map-marker-alt"></i>
                                        </span>
                                        <input type="text"
                                               class="form-control"
                                               value="@ViewBag.SitioTuristicoNombre"
                                               readonly>
                                    </div>
                                    <div class="form-text">Sitio turístico al que pertenece este comentario</div>
                                </div>

                                <!-- Usuario (solo lectura) -->
                                <div class="form-group">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-user me-2 text-muted"></i>Usuario
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-user-circle"></i>
                                        </span>
                                        <input type="text"
                                               class="form-control"
                                               value="@ViewBag.UsuarioNombre"
                                               readonly>
                                    </div>
                                    <div class="form-text">Usuario que realizó el comentario</div>
                                </div>
                            </div>
                        </div>

                        <!-- Panel de Estadísticas -->
                        <div class="col-lg-4 border-start bg-light">
                            <div class="p-4">
                                <h5 class="fw-semibold mb-3">
                                    <i class="fas fa-chart-bar me-2 text-primary"></i>Estadísticas
                                </h5>

                                <div class="border rounded-3 p-3 bg-white">
                                    <h6 class="fw-semibold mb-2 text-dark">
                                        <i class="fas fa-history me-2 text-success"></i>Información
                                    </h6>

                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="small text-muted">Creado:</span>
                                            <span class="badge bg-primary">@Model.Fecha.ToString("dd/MM/yyyy")</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="small text-muted">Calificación:</span>
                                            <div class="text-warning" id="currentRating">
                                                @for (int i = 0; i < Model.Puntuacion; i++)
                                                {
                                                    <i class="fas fa-star"></i>
                                                }
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Contador de caracteres -->
                                    <div class="mt-3 pt-3 border-top">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="small text-muted">Longitud:</span>
                                            <span class="badge bg-primary" id="textLengthBadge">
                                                @texto.Length/1000
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Badge de estado -->
                                <div class="mt-3">
                                    <span class="badge bg-success px-3 py-2 me-2" id="editStatus">
                                        <i class="fas fa-check-circle me-1"></i>Comentario existente
                                    </span>
                                    <span class="badge bg-warning px-3 py-2" id="modifiedStatus" style="display: none;">
                                        <i class="fas fa-edit me-1"></i>Modificaciones pendientes
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido del Comentario -->
            <div class="row g-4 mb-4">
                <!-- Columna Izquierda - Contenido -->
                <div class="col-lg-8">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-header border-bottom py-3">
                            <h4 class="h5 mb-0">
                                <i class="fas fa-comment-dots me-2"></i>Contenido del Comentario
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <label asp-for="Texto" class="form-label fw-semibold">
                                    <i class="fas fa-align-left me-2 text-muted"></i>Comentario *
                                </label>
                                <textarea asp-for="Texto"
                                          class="form-control"
                                          rows="6"
                                          placeholder="Escribe tu experiencia, opinión o recomendación sobre este sitio turístico..."
                                          required
                                          id="textoInput"
                                          maxlength="1000"
                                          data-bs-toggle="tooltip"
                                          data-bs-title="Tu experiencia personal en el sitio turístico">@texto</textarea>
                                <div class="form-text text-end">
                                    <span class="text-muted" id="textoCounter">@texto.Length/1000</span>
                                </div>
                                <span asp-validation-for="Texto" class="invalid-feedback"></span>
                            </div>

                            <!-- Fecha de publicación -->
                            <div class="form-group">
                                <label asp-for="Fecha" class="form-label fw-semibold">
                                    <i class="fas fa-calendar-alt me-2 text-muted"></i>Fecha del Comentario *
                                </label>
                                <input asp-for="Fecha"
                                       class="form-control"
                                       type="date"
                                       required
                                       id="fechaInput"
                                       value="@fecha"
                                       data-bs-toggle="tooltip"
                                       data-bs-title="Fecha en que visitaste el sitio o realizas el comentario">
                                <span asp-validation-for="Fecha" class="invalid-feedback"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha - Calificación -->
                <div class="col-lg-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-header border-bottom py-3">
                            <h4 class="h5 mb-0">
                                <i class="fas fa-star me-2"></i>Calificación
                            </h4>
                        </div>
                        <div class="card-body">
                            <!-- Sistema de puntuación -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold d-block">
                                    <i class="fas fa-star me-2 text-muted"></i>Puntuación *
                                </label>

                                <div class="text-center mb-3">
                                    <div class="rating-stars mb-2" id="ratingStars">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            <i class="fas fa-star fa-2x star @(i <= puntuacion ? "text-warning" : "text-muted")"
                                               data-value="@i"
                                               role="button"
                                               tabindex="0"
                                               aria-label="@i estrellas"
                                               aria-pressed="@(i <= puntuacion ? "true" : "false")"></i>
                                        }
                                    </div>
                                    <small class="text-muted" id="ratingText">
                                        @(puntuacion switch
                                        {
                                            1 => "Mala experiencia",
                                            2 => "Regular",
                                            3 => "Buena",
                                            4 => "Muy buena",
                                            5 => "Excelente",
                                            _ => "Selecciona calificación"
                                        })
                                    </small>
                                </div>

                                <input type="hidden" asp-for="Puntuacion" id="puntuacionInput" value="@puntuacion" />
                                <span asp-validation-for="Puntuacion" class="invalid-feedback"></span>
                            </div>

                            <!-- Preview de calificación -->
                            <div class="border rounded-3 p-3 bg-white mb-4">
                                <h6 class="fw-semibold mb-2">
                                    <i class="fas fa-info-circle me-2 text-info"></i>Tu Calificación
                                </h6>
                                <div class="d-flex align-items-center justify-content-between">
                                    <div id="selectedRating" class="text-warning fs-4">
                                        @for (int i = 0; i < 5; i++)
                                        {
                                            <i class="fas fa-star" style="@(i < puntuacion ? "opacity: 1;" : "opacity: 0.3;")"></i>
                                        }
                                    </div>
                                    <span class="fw-semibold" id="ratingValue">@puntuacion/5</span>
                                </div>
                                <div id="ratingDescription" class="small text-muted mt-2">
                                    @(puntuacion switch
                                    {
                                        1 => "Mala experiencia - No lo recomendaría",
                                        2 => "Regular - Podría mejorar",
                                        3 => "Buena - Satisfactorio",
                                        4 => "Muy buena - Lo recomendaría",
                                        5 => "Excelente - Altamente recomendado",
                                        _ => "Selecciona las estrellas"
                                    })
                                </div>
                            </div>

                            <!-- Guía de puntuación -->
                            <div class="small">
                                <p class="mb-1"><i class="fas fa-star text-warning"></i> <strong>1:</strong> Mala experiencia</p>
                                <p class="mb-1"><i class="fas fa-star text-warning"></i><i class="fas fa-star text-warning"></i> <strong>2:</strong> Regular</p>
                                <p class="mb-1"><i class="fas fa-star text-warning"></i><i class="fas fa-star text-warning"></i><i class="fas fa-star text-warning"></i> <strong>3:</strong> Buena</p>
                                <p class="mb-1"><i class="fas fa-star text-warning"></i><i class="fas fa-star text-warning"></i><i class="fas fa-star text-warning"></i><i class="fas fa-star text-warning"></i> <strong>4:</strong> Muy buena</p>
                                <p><i class="fas fa-star text-warning"></i><i class="fas fa-star text-warning"></i><i class="fas fa-star text-warning"></i><i class="fas fa-star text-warning"></i><i class="fas fa-star text-warning"></i> <strong>5:</strong> Excelente</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Acciones con Modal de Confirmación -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
                        <div class="text-center text-md-start">
                            <h5 class="fw-semibold mb-1">¿Estás listo para guardar los cambios?</h5>
                            <p class="text-muted small mb-0">
                                Verifica que toda la información sea correcta antes de actualizar
                            </p>
                        </div>

                        <div class="d-flex gap-3">
                            <button type="button" class="btn btn-outline-danger btn-lg px-5"
                                    data-bs-toggle="modal" data-bs-target="#restoreModal">
                                <i class="fas fa-undo me-2"></i>Restaurar Original
                            </button>
                            <button type="submit" class="btn btn-success btn-lg px-5" id="submitBtn">
                                <i class="fas fa-save me-2"></i>Actualizar Comentario
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Confirmación para Restaurar -->
<div class="modal fade" id="restoreModal" tabindex="-1" aria-labelledby="restoreModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="restoreModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirmar Restauración
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas restaurar todos los valores originales?</p>
                <p class="text-muted small">Se perderán todos los cambios no guardados.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="confirmRestore">
                    <i class="fas fa-undo me-2"></i>Restaurar Todo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast para Mensajes -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-info-circle me-2 text-primary"></i>
            <strong class="me-auto">Sistema</strong>
            <small>Ahora</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Mensaje de ejemplo
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Configuración global para Edit de Comentarios
        const config = {
            isTestMode: window.navigator.webdriver === true ||
                       window.location.search.includes('testmode'),
            originalData: {
                Texto: "@Html.Raw(texto.Replace("\"", "\\\"").Replace("\r\n", "\\n"))",
                Puntuacion: @puntuacion,
                Fecha: '@fecha'
            }
        };

        // Módulo para manejo del formulario en edición
        const formManager = {
            hasChanges: false,
            originalValues: {},

            init() {
                // Configurar modo test si es necesario
                if (config.isTestMode) {
                    document.body.classList.add('test-mode');
                    console.log('✅ Modo de pruebas activado - Edición de Comentario');
                }

                // Inicializar componentes básicos
                this.initBasicComponents();
                this.saveOriginalValues();
                this.setupCharacterCounters();
                this.setupRatingSystem();
                this.setupChangeDetection();

                // Configurar validación según modo
                if (config.isTestMode) {
                    this.setupTestFriendlyForm();
                } else {
                    this.setupUserFriendlyForm();
                }

                // Configurar modal de restauración
                this.setupRestoreModal();
            },

            initBasicComponents() {
                // Tooltips
                if (!config.isTestMode) {
                    try {
                        var tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                        [...tooltips].forEach(el => new bootstrap.Tooltip(el));
                    } catch (e) {
                        console.log('Tooltips no disponibles:', e.message);
                    }
                }

                // Toast
                try {
                    var toastEl = document.getElementById('liveToast');
                    if (toastEl) window.appToast = new bootstrap.Toast(toastEl);
                } catch (e) {}

                // Alert dismissible
                try {
                    var alertEl = document.querySelector('.alert.alert-info');
                    if (alertEl) {
                        var closeBtn = alertEl.querySelector('.btn-close');
                        if (closeBtn) {
                            closeBtn.addEventListener('click', () => {
                                alertEl.style.display = 'none';
                            });
                        }
                    }
                } catch (e) {}
            },

            saveOriginalValues() {
                // Guardar valores originales
                this.originalValues = {
                    Texto: config.originalData.Texto,
                    Puntuacion: config.originalData.Puntuacion,
                    Fecha: config.originalData.Fecha
                };
            },

            setupCharacterCounters() {
                const textoInput = document.getElementById('textoInput');
                const textoCounter = document.getElementById('textoCounter');
                const textLengthBadge = document.getElementById('textLengthBadge');

                if (textoInput && textoCounter) {
                    const update = () => {
                        const length = textoInput.value.length;
                        textoCounter.textContent = `${length}/1000`;

                        if (textLengthBadge) {
                            textLengthBadge.textContent = `${length}/1000`;
                            textLengthBadge.className = 'badge ' +
                                (length === 0 ? 'bg-secondary' :
                                 length > 1000 ? 'bg-danger' :
                                 length > 900 ? 'bg-warning' : 'bg-primary');
                        }

                        if (!config.isTestMode) {
                            textoCounter.className = 'text-muted';
                            if (length > 900) textoCounter.classList.add('text-warning');
                            if (length > 1000) textoCounter.classList.add('text-danger');
                        }
                    };

                    textoInput.addEventListener('input', update);
                    update(); // Estado inicial
                }
            },

            setupRatingSystem() {
                const stars = document.querySelectorAll('.rating-stars .star');
                const puntuacionInput = document.getElementById('puntuacionInput');
                const selectedRating = document.getElementById('selectedRating');
                const ratingValue = document.getElementById('ratingValue');
                const ratingDescription = document.getElementById('ratingDescription');
                const ratingText = document.getElementById('ratingText');

                const ratingMessages = {
                    0: { text: "Selecciona calificación", desc: "Sin calificar" },
                    1: { text: "Mala experiencia", desc: "No lo recomendaría" },
                    2: { text: "Regular", desc: "Podría mejorar" },
                    3: { text: "Buena", desc: "Satisfactorio" },
                    4: { text: "Muy buena", desc: "Lo recomendaría" },
                    5: { text: "Excelente", desc: "Altamente recomendado" }
                };

                const updateRatingDisplay = (rating) => {
                    rating = parseInt(rating) || 0;

                    // Actualizar estrellas visuales
                    stars.forEach((star, index) => {
                        const starValue = parseInt(star.dataset.value);
                        if (starValue <= rating) {
                            star.classList.add('text-warning');
                            star.classList.remove('text-muted');
                            star.setAttribute('aria-pressed', 'true');
                        } else {
                            star.classList.remove('text-warning');
                            star.classList.add('text-muted');
                            star.setAttribute('aria-pressed', 'false');
                        }
                    });

                    // Actualizar preview de calificación
                    if (selectedRating) {
                        const starsHtml = Array(5).fill(0).map((_, i) =>
                            `<i class="fas fa-star${i < rating ? ' text-warning' : ' text-muted opacity-50'}"></i>`
                        ).join('');
                        selectedRating.innerHTML = starsHtml;
                    }

                    if (ratingValue) ratingValue.textContent = `${rating}/5`;

                    // Actualizar textos
                    const msg = ratingMessages[rating];
                    if (ratingDescription) ratingDescription.textContent = msg.desc;
                    if (ratingText) {
                        ratingText.textContent = msg.text;
                        ratingText.className = rating >= 4 ? 'text-success' :
                                              rating >= 3 ? 'text-primary' :
                                              rating >= 1 ? 'text-warning' : 'text-muted';
                    }

                    // Actualizar campo oculto
                    if (puntuacionInput) puntuacionInput.value = rating;
                };

                // Eventos para las estrellas
                stars.forEach(star => {
                    star.addEventListener('click', (e) => {
                        const rating = parseInt(e.currentTarget.dataset.value);
                        updateRatingDisplay(rating);
                        this.checkForChanges();
                    });

                    star.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            const rating = parseInt(e.currentTarget.dataset.value);
                            updateRatingDisplay(rating);
                            this.checkForChanges();
                        }
                    });

                    star.addEventListener('mouseover', (e) => {
                        const hoverRating = parseInt(e.currentTarget.dataset.value);
                        stars.forEach(s => {
                            const starValue = parseInt(s.dataset.value);
                            if (starValue <= hoverRating) {
                                s.classList.add('text-warning');
                                s.classList.remove('text-muted');
                            }
                        });
                    });

                    star.addEventListener('mouseout', () => {
                        const currentRating = puntuacionInput ? parseInt(puntuacionInput.value) : 0;
                        updateRatingDisplay(currentRating);
                    });
                });

                // Inicializar con valor del modelo
                const initialRating = @puntuacion;
                updateRatingDisplay(initialRating);
            },

            setupChangeDetection() {
                const form = document.getElementById('commentForm');
                if (!form) return;

                const inputs = form.querySelectorAll('input, textarea');

                inputs.forEach(input => {
                    input.addEventListener('input', () => this.checkForChanges());
                    input.addEventListener('change', () => this.checkForChanges());
                });
            },

            checkForChanges() {
                let hasChanges = false;
                const form = document.getElementById('commentForm');

                if (!form) return false;

                // Verificar texto
                const textoInput = document.getElementById('textoInput');
                if (textoInput && textoInput.value !== this.originalValues.Texto) {
                    hasChanges = true;
                }

                // Verificar fecha
                const fechaInput = document.getElementById('fechaInput');
                if (fechaInput && fechaInput.value !== this.originalValues.Fecha) {
                    hasChanges = true;
                }

                // Verificar puntuación
                const puntuacionInput = document.getElementById('puntuacionInput');
                if (puntuacionInput && parseInt(puntuacionInput.value) !== this.originalValues.Puntuacion) {
                    hasChanges = true;
                }

                this.hasChanges = hasChanges;
                this.updateModifiedStatus();
                return hasChanges;
            },

            updateModifiedStatus() {
                const editStatus = document.getElementById('editStatus');
                const modifiedStatus = document.getElementById('modifiedStatus');

                if (editStatus && modifiedStatus) {
                    if (this.hasChanges) {
                        editStatus.style.display = 'none';
                        modifiedStatus.style.display = 'inline-block';
                    } else {
                        editStatus.style.display = 'inline-block';
                        modifiedStatus.style.display = 'none';
                    }
                }
            },

            setupUserFriendlyForm() {
                const form = document.getElementById('commentForm');
                const submitBtn = document.getElementById('submitBtn');

                if (!form || !submitBtn) return;

                // Configurar validación en tiempo real
                this.setupRealTimeValidation(form);

                // Configurar envío del formulario
                form.addEventListener('submit', (e) => {
                    if (!this.validateFormBeforeSubmit()) {
                        e.preventDefault();
                        return false;
                    }

                    // Mostrar estado de carga
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = `
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        Actualizando...
                    `;

                    return true;
                });
            },

            setupTestFriendlyForm() {
                const form = document.getElementById('commentForm');
                const submitBtn = document.getElementById('submitBtn');

                if (!form || !submitBtn) return;

                console.log('Configurando formulario para pruebas...');

                // Desactivar validaciones automáticas
                form.noValidate = true;
                form.classList.remove('needs-validation');

                // Simplificar envío del formulario
                form.addEventListener('submit', (e) => {
                    // Validación mínima
                    let isValid = true;

                    const textoInput = document.getElementById('textoInput');
                    const fechaInput = document.getElementById('fechaInput');
                    const puntuacionInput = document.getElementById('puntuacionInput');

                    if (!textoInput || !textoInput.value.trim()) {
                        isValid = false;
                        if (textoInput) textoInput.classList.add('is-invalid');
                    }

                    if (!fechaInput || !fechaInput.value) {
                        isValid = false;
                        if (fechaInput) fechaInput.classList.add('is-invalid');
                    }

                    if (!puntuacionInput || parseInt(puntuacionInput.value) === 0) {
                        isValid = false;
                        if (puntuacionInput) puntuacionInput.classList.add('is-invalid');
                    }

                    if (!isValid) {
                        e.preventDefault();
                        return false;
                    }

                    // Estado de carga simplificado
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = 'Enviando...';

                    return true;
                });
            },

            setupRealTimeValidation(form) {
                form.querySelectorAll('input, textarea').forEach(field => {
                    field.addEventListener('blur', function() {
                        validateSingleField(this);
                    });
                });
            },

            validateFormBeforeSubmit() {
                let isValid = true;
                const form = document.getElementById('commentForm');

                // Validar texto del comentario
                const textoInput = form.querySelector('[name="Texto"]');
                if (!textoInput || !textoInput.value.trim()) {
                    isValid = false;
                    textoInput.classList.add('is-invalid');
                    this.showMessage('El comentario es requerido', 'danger');
                    textoInput.focus();
                } else if (textoInput.value.length > 1000) {
                    isValid = false;
                    textoInput.classList.add('is-invalid');
                    this.showMessage('El comentario no puede exceder 1000 caracteres', 'danger');
                    textoInput.focus();
                }

                // Validar fecha
                const fechaInput = form.querySelector('[name="Fecha"]');
                if (!fechaInput || !fechaInput.value) {
                    isValid = false;
                    fechaInput.classList.add('is-invalid');
                    this.showMessage('La fecha es requerida', 'danger');
                    if (!textoInput || textoInput.value.trim()) fechaInput.focus();
                } else {
                    const selectedDate = new Date(fechaInput.value);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (selectedDate > today) {
                        isValid = false;
                        fechaInput.classList.add('is-invalid');
                        this.showMessage('La fecha no puede ser futura', 'danger');
                    }
                }

                // Validar puntuación
                const puntuacionInput = form.querySelector('[name="Puntuacion"]');
                const puntuacion = puntuacionInput ? parseInt(puntuacionInput.value) : 0;
                if (puntuacion < 1 || puntuacion > 5) {
                    isValid = false;
                    if (puntuacionInput) puntuacionInput.classList.add('is-invalid');
                    this.showMessage('Debes calificar el sitio con 1-5 estrellas', 'danger');

                    // Resaltar las estrellas
                    const starsContainer = document.getElementById('ratingStars');
                    if (starsContainer) {
                        starsContainer.style.boxShadow = '0 0 0 0.25rem rgba(220,53,69,.25)';
                        setTimeout(() => {
                            starsContainer.style.boxShadow = '';
                        }, 3000);
                    }
                }

                return isValid;
            },

            setupRestoreModal() {
                const confirmBtn = document.getElementById('confirmRestore');
                const modal = document.getElementById('restoreModal');

                if (confirmBtn && modal) {
                    confirmBtn.addEventListener('click', () => {
                        const bsModal = bootstrap.Modal.getInstance(modal);
                        this.restoreForm();
                        bsModal.hide();
                        this.showMessage('Valores originales restaurados', 'success');
                    });
                }
            },

            restoreForm() {
                if (!this.checkForChanges()) {
                    this.showMessage('No hay cambios para restaurar', 'info');
                    return;
                }

                // Restaurar valores del formulario
                const textoInput = document.getElementById('textoInput');
                const fechaInput = document.getElementById('fechaInput');
                const puntuacionInput = document.getElementById('puntuacionInput');

                if (textoInput) textoInput.value = this.originalValues.Texto;
                if (fechaInput) fechaInput.value = this.originalValues.Fecha;
                if (puntuacionInput) puntuacionInput.value = this.originalValues.Puntuacion;

                // Restaurar rating visual
                this.setupRatingSystem();

                // Restaurar contadores
                this.setupCharacterCounters();

                // Restaurar validaciones
                const form = document.getElementById('commentForm');
                if (form) {
                    form.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
                        el.classList.remove('is-valid', 'is-invalid');
                    });
                }

                // Restaurar estado del botón
                const submitBtn = document.getElementById('submitBtn');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Actualizar Comentario';
                }

                this.hasChanges = false;
                this.updateModifiedStatus();
            },

            showMessage(message, type = 'info') {
                const toastEl = document.getElementById('liveToast');
                const toastMsg = document.getElementById('toastMessage');

                if (toastEl && toastMsg && window.appToast) {
                    const iconMap = {
                        'success': 'check-circle',
                        'danger': 'exclamation-triangle',
                        'warning': 'exclamation-circle',
                        'info': 'info-circle'
                    };

                    const icon = toastEl.querySelector('i');
                    if (icon) {
                        icon.className = `fas fa-${iconMap[type] || 'info-circle'} me-2 text-${type}`;
                    }

                    toastMsg.textContent = message;
                    window.appToast.show();
                } else {
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }
        };

        // Función de ayuda para validación individual
        function validateSingleField(field) {
            if (field.hasAttribute('required') && !field.value.trim()) {
                field.classList.add('is-invalid');
                field.classList.remove('is-valid');
                return false;
            }

            if (field.hasAttribute('maxlength')) {
                const max = parseInt(field.getAttribute('maxlength'));
                if (field.value.length > max) {
                    field.classList.add('is-invalid');
                    field.classList.remove('is-valid');
                    return false;
                }
            }

            // Validación especial para fecha
            if (field.type === 'date' && field.value) {
                const selectedDate = new Date(field.value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (selectedDate > today) {
                    field.classList.add('is-invalid');
                    field.classList.remove('is-valid');
                    return false;
                }
            }

            if (field.value.trim()) {
                field.classList.add('is-valid');
                field.classList.remove('is-invalid');
            } else {
                field.classList.remove('is-valid', 'is-invalid');
            }

            return true;
        }

        // Inicialización principal
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando formulario de edición de comentario...');

            // Inicializar gestor del formulario
            formManager.init();
        });
    </script>
}