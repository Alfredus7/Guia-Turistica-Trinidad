@model guia_turistico.Models.ImagenesSitios

@{
    ViewData["Title"] = "Editar Imagen";
}

<style>
    /* Estilos específicos para esta vista */
    .bg-primary-gradient {
        background: var(--gradient-verde) !important;
    }

    .card-header-gradient {
        background: var(--gradient-verde) !important;
        color: white;
    }

    .bg-light-subtle {
        background-color: #f8f9fa !important;
    }

    .input-group-custom {
        background-color: #f8f9fa !important;
        border: 1px solid var(--border-color);
        border-right: none;
    }

    .badge-primary {
        background-color: var(--verde-amazonico) !important;
    }

    /* Estilos para la imagen actual */
    .current-image-container {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        background-color: #f8f9fa;
        margin-bottom: 20px;
    }

    .current-image {
        max-width: 100%;
        max-height: 300px;
        object-fit: contain;
        border-radius: 6px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .btn-lg {
        padding: 0.75rem 1.5rem;
    }

    /* Estados de validación */
    .is-valid-border {
        border-color: #28a745 !important;
    }

    .is-invalid-border {
        border-color: #dc3545 !important;
    }
</style>

<div class="container py-4">
    <!-- Header con navegación -->
    <div class="bg-primary-gradient text-white py-4">
        <div class="container">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
                <div class="text-center text-md-start">
                    <h1 class="display-6 fw-bold mb-1">
                        <i class="fas fa-edit me-2"></i>Editar Imagen
                    </h1>
                    <p class="lead mb-0 opacity-75">Modifica la información de la imagen #@Model.Id</p>
                </div>
                <a asp-action="Index" class="btn btn-outline-light btn-lg">
                    <i class="fas fa-arrow-left me-2"></i>Volver al Listado
                </a>
            </div>
        </div>
    </div>

    <!-- Form Container -->
    <div class="row justify-content-center mt-4">
        <div class="col-lg-10 col-xl-9">
            <div class="card shadow-lg border-0 rounded-3 overflow-hidden">
                <!-- Card Header -->
                <div class="card-header card-header-gradient py-3">
                    <h2 class="h5 mb-0">
                        <i class="fas fa-image me-2"></i>Editar Imagen
                    </h2>
                </div>

                <!-- Card Body -->
                <div class="card-body p-4 p-md-5">
                    <form asp-action="Edit" id="editImageForm" class="needs-validation" novalidate>
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                        <input type="hidden" asp-for="Id" />

                        <!-- Sitio Turístico Selection (solo lectura) -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-map-marker-alt me-2"></i>Sitio Turístico
                            </label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text input-group-custom">
                                    <i class="fas fa-landmark text-muted"></i>
                                </span>
                                <select class="form-select" disabled>
                                    <option selected>@ViewBag.SitioTuristicoNombre</option>
                                </select>
                            </div>
                            <input type="hidden" asp-for="SitioTuristicoId" />
                            <div class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                No se puede cambiar el sitio turístico. Para mover esta imagen, elimínela y agréguela al nuevo sitio.
                            </div>
                        </div>

                        <!-- Current Image Preview -->
                        <div class="mb-4">
                            <h4 class="h6 mb-3 fw-semibold text-dark">
                                <i class="fas fa-eye me-2 text-info"></i>Imagen Actual
                            </h4>
                            <div class="current-image-container text-center">
                                <img src="@Model.Url"
                                     class="current-image"
                                     alt="Imagen actual"
                                     id="currentImagePreview"
                                     onerror="this.onerror=null; this.src='https://via.placeholder.com/400x225/6c757d/ffffff?text=Imagen+No+Disponible'">
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-link me-1"></i>
                                        <span id="currentUrlText">@Model.Url</span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- URL Input Section -->
                        <div class="border rounded-3 p-4 mb-4 bg-light-subtle">
                            <h4 class="h6 mb-3 fw-semibold text-dark">
                                <i class="fas fa-link me-2"></i>Nueva URL de la Imagen
                            </h4>

                            <div class="row g-3 align-items-end">
                                <div class="col-md-9">
                                    <label asp-for="Url" class="form-label small fw-medium">
                                        URL de la imagen
                                    </label>
                                    <input asp-for="Url"
                                           type="url"
                                           class="form-control"
                                           id="imageUrlInput"
                                           placeholder="https://ejemplo.com/imagen.jpg"
                                           pattern="https?://.+"
                                           required>
                                    <span asp-validation-for="Url" class="text-danger small mt-1 d-block"></span>
                                    <div class="invalid-feedback">
                                        Por favor ingresa una URL válida comenzando con http:// o https://
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <button type="button"
                                            class="btn btn-success w-100"
                                            id="previewBtn">
                                        <i class="fas fa-eye me-2"></i>Previsualizar
                                    </button>
                                </div>
                            </div>

                            <div class="mt-3">
                                <div class="alert alert-info mb-2 py-2">
                                    <small>
                                        <i class="fas fa-lightbulb me-2"></i>
                                        <strong>Formatos soportados:</strong> .jpg, .png, .gif, .bmp, .webp, .svg
                                    </small>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Modifica la URL de la imagen y haz clic en "Previsualizar" para ver el cambio
                                </small>
                            </div>
                        </div>

                        <!-- Preview Section -->
                        <div id="newPreviewSection" style="display: none;">
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 class="h6 fw-semibold text-dark mb-0">
                                        <i class="fas fa-sync-alt me-2 text-warning"></i>Nueva Vista Previa
                                    </h4>
                                </div>

                                <!-- New Preview -->
                                <div class="current-image-container text-center">
                                    <img id="newImagePreview"
                                         class="current-image"
                                         alt="Nueva vista previa"
                                         onerror="previewError(this)">
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="fas fa-link me-1"></i>
                                            <span id="newUrlText"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="border-top pt-4 mt-4">
                            <div class="d-flex flex-column flex-md-row justify-content-center align-items-center gap-3">
                                <div class="d-flex flex-column flex-md-row gap-3 w-100">
                                    <a asp-action="Index" class="btn btn-outline-secondary btn-lg flex-fill">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                    <button type="submit"
                                            class="btn btn-primary btn-lg flex-fill"
                                            id="submitBtn">
                                        <i class="fas fa-save me-2"></i>Guardar Cambios
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const imageUrlInput = document.getElementById('imageUrlInput');
            const previewBtn = document.getElementById('previewBtn');
            const currentImagePreview = document.getElementById('currentImagePreview');
            const newPreviewSection = document.getElementById('newPreviewSection');
            const newImagePreview = document.getElementById('newImagePreview');
            const newUrlText = document.getElementById('newUrlText');
            const currentUrlText = document.getElementById('currentUrlText');
            const editImageForm = document.getElementById('editImageForm');
            const submitBtn = document.getElementById('submitBtn');

            // Store original URL
            const originalUrl = '@Model.Url';

            // Validation function
            function isValidImageUrl(url) {
                if (!url) return false;

                try {
                    const urlObj = new URL(url);

                    // Check protocol
                    if (!['http:', 'https:'].includes(urlObj.protocol)) {
                        return false;
                    }

                    // Check file extension
                    const pathname = urlObj.pathname.toLowerCase();
                    const validExtensions = [
                        '.jpg', '.jpeg', '.jfif', '.pjpeg', '.pjp',
                        '.png', '.gif', '.bmp', '.webp', '.svg', '.avif'
                    ];

                    return validExtensions.some(ext => pathname.endsWith(ext));
                } catch {
                    return false;
                }
            }

            // Show toast notification
            function showToast(message, type = 'info') {
                // Remove existing toasts
                document.querySelectorAll('.toast').forEach(toast => toast.remove());

                const toastHtml = `
                    <div class="toast align-items-center text-bg-${type} border-0 fade show"
                         role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 1050;">
                        <div class="d-flex">
                            <div class="toast-body">
                                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', toastHtml);

                // Auto remove after 5 seconds
                setTimeout(() => {
                    const toast = document.querySelector('.toast');
                    if (toast) toast.remove();
                }, 5000);
            }

            // Handle image preview error
            window.previewError = function(imgElement) {
                imgElement.src = 'https://via.placeholder.com/400x225/6c757d/ffffff?text=URL+de+Imagen+No+Válida';
                showToast('No se pudo cargar la imagen. Verifica que la URL sea correcta.', 'danger');
            }

            // Update preview function
            function updatePreview() {
                const url = imageUrlInput.value.trim();

                if (!url) {
                    showToast('Por favor ingresa una URL', 'warning');
                    imageUrlInput.classList.add('is-invalid');
                    return false;
                }

                if (!isValidImageUrl(url)) {
                    showToast('URL no válida. Asegúrate que sea una imagen (jpg, png, gif, etc.)', 'danger');
                    imageUrlInput.classList.add('is-invalid');
                    return false;
                }

                if (url === originalUrl) {
                    showToast('Esta es la misma URL actual. No hay cambios para previsualizar.', 'info');
                    newPreviewSection.style.display = 'none';
                    imageUrlInput.classList.remove('is-invalid');
                    imageUrlInput.classList.add('is-valid');
                    return false;
                }

                // Update preview image
                newImagePreview.src = url;
                newUrlText.textContent = url.length > 50 ? url.substring(0, 50) + '...' : url;

                // Show preview section
                newPreviewSection.style.display = 'block';

                // Scroll to preview
                newPreviewSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Remove invalid class
                imageUrlInput.classList.remove('is-invalid');
                imageUrlInput.classList.add('is-valid');

                showToast('Vista previa actualizada', 'success');
                return true;
            }

            // Real-time URL validation
            imageUrlInput.addEventListener('input', function() {
                const url = this.value.trim();

                if (!url) {
                    this.classList.remove('is-invalid', 'is-valid');
                    newPreviewSection.style.display = 'none';
                    return;
                }

                if (url === originalUrl) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                    newPreviewSection.style.display = 'none';
                    return;
                }

                if (isValidImageUrl(url)) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                    newPreviewSection.style.display = 'none';
                }
            });

            // Preview button click
            previewBtn.addEventListener('click', updatePreview);

            // Enter key in URL input
            imageUrlInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    updatePreview();
                }
            });

            // Image load event for new preview
            newImagePreview.addEventListener('load', function() {
                showToast('Nueva imagen cargada correctamente', 'success');
            });

            // Form submission
            editImageForm.addEventListener('submit', function(e) {
                if (!imageUrlInput.value.trim()) {
                    e.preventDefault();
                    showToast('Debes ingresar una URL para la imagen', 'danger');
                    return;
                }

                if (!isValidImageUrl(imageUrlInput.value)) {
                    e.preventDefault();
                    showToast('La URL de la imagen no es válida', 'danger');
                    return;
                }

                const newUrl = imageUrlInput.value.trim();

                if (originalUrl === newUrl) {
                    if (!confirm('No has realizado cambios en la URL. ¿Deseas guardar de todas formas?')) {
                        e.preventDefault();
                        return;
                    }
                } else {
                    // Check if new image loaded successfully
                    if (newImagePreview.src.includes('placeholder.com') && newUrl !== originalUrl) {
                        if (!confirm('La nueva imagen no se pudo cargar correctamente. ¿Estás seguro de que quieres guardar esta URL?')) {
                            e.preventDefault();
                            return;
                        }
                    }
                }

                // Show loading state
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
                submitBtn.disabled = true;
            });

            // Initialize
            // Validate current URL on load
            if (imageUrlInput.value && isValidImageUrl(imageUrlInput.value)) {
                imageUrlInput.classList.add('is-valid');
            }
        });
    </script>
}